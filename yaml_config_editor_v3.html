<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAML Configuration Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #C6C6C6 0%, #C6C6C6 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #898a8a, #7c7c7d);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .content {
            display: flex;
            min-height: 70vh;
        }
        
        .editor-panel {
            flex: 1;
            padding: 30px;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            max-height: 70vh;
        }
        
        .preview-panel {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .section {
            background: white;
            margin-bottom: 25px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }
        
        .section h3::before {
            content: "‚öôÔ∏è";
            margin-right: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .sources-container {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .source-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .source-item h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .remove-source {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .remove-source:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
        
        .add-source {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .add-source:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .yaml-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 25px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 60vh;
            overflow-y: auto;
            line-height: 1.6;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .actions {
            padding: 25px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }
        
        .download-btn {
            background: linear-gradient(45deg, #656567, #111111);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .target-config {
            display: none;
        }
        
        .target-config.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
            <img src="ry_logo2.png" style="max-height: 300px; max-width: 300px;" alt="Rylos Data Solutions Logo" />
            </h1>
            <h1>üîß YAML Configuration Editor</h1>
            <p>Edit your database extraction configuration with ease</p>
        </div>
        
        <div class="content">
            <div class="editor-panel">
                <!-- Source Database Configuration -->
                <div class="section">
                    <h3>Database Connection</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Database Type:</label>
                            <select id="db_type">
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                                <option value="oracle">Oracle</option>
                                <option value="mssql">SQL Server</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Host:</label>
                            <input type="text" id="db_host" value="127.0.0.1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Port:</label>
                            <input type="number" id="db_port" value="5432">
                        </div>
                        <div class="form-group">
                            <label>Database:</label>
                            <input type="text" id="db_database" value="postgres">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>User:</label>
                            <input type="text" id="db_user" value="user">
                        </div>
                        <div class="form-group">
                            <label>Password:</label>
                            <input type="password" id="db_password" value="secret">
                        </div>
                    </div>
                    
                        <div class="form-group">
                            <label>url (provide a full SQLAlchemy URL):</label>
                            <input type="text" id="url" value="">
                        </div>
                                       
                </div>

                <!-- Sources Configuration -->
                <div class="section">
                    <h3>Data Sources</h3>
                    <div class="sources-container" id="sources-container">
                        <!-- Sources will be dynamically added here -->
                    </div>
                    <button class="add-source" onclick="addSource()">+ Add New Source</button>
                </div>

                <!-- Target Configuration -->
                <div class="section">
                    <h3>Target Storage</h3>
                    <div class="form-group">
                        <label>Storage Type:</label>
                        <select id="target_type" onchange="toggleTargetConfig()">
                            <option value="gcs">Google Cloud Storage</option>
                            <option value="s3">Amazon S3</option>
                            <option value="azure">Azure Storage</option>
                            <option value="local">Local Storage</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Global Object Name Template:</label>
                        <input type="text" id="global_object_name" value="exports/{{schema}}/{{table}}/{{part_date}}/run={{run_ts}}.parquet">
                    </div>
                    
                    <!-- GCS Config -->
                    <div class="target-config active" id="gcs-config">
                        <div class="form-row">
                            <div class="form-group">
                                <label>GCS Bucket:</label>
                                <input type="text" id="gcs_bucket" value="your_GCP_bucket">
                            </div>
                            <div class="form-group">
                                <label>Service Account Key File:</label>
                                <input type="text" id="gcs_key_file" value="path to serivce account key.json">
                            </div>
                        </div>
                    </div>
                    
                    <!-- S3 Config -->
                    <div class="target-config" id="s3-config">
                        <div class="form-row">
                            <div class="form-group">
                                <label>S3 Bucket:</label>
                                <input type="text" id="s3_bucket" value="my-s3-bucket">
                            </div>
                            <div class="form-group">
                                <label>Region:</label>
                                <input type="text" id="s3_region" value="us-east-1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>AWS Access Key ID:</label>
                                <input type="text" id="s3_access_key" value="YOUR_KEY">
                            </div>
                            <div class="form-group">
                                <label>AWS Secret Access Key:</label>
                                <input type="password" id="s3_secret_key" value="YOUR_SECRET">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Azure Config -->
                    <div class="target-config" id="azure-config">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Container:</label>
                                <input type="text" id="azure_container" value="my-container">
                            </div>
                            <div class="form-group">
                                <label>Account Name:</label>
                                <input type="text" id="azure_account_name" value="myaccount">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Account Key:</label>
                            <input type="password" id="azure_account_key" value="YOUR_ACCOUNT_KEY">
                        </div>
                    </div>
                </div>

                <!-- IO Configuration -->
                <div class="section">
                    <h3>IO & Performance Settings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Chunk Size:</label>
                            <input type="number" id="io_chunksize" value="100000">
                        </div>
                        <div class="form-group">
                            <label>Parquet Compression:</label>
                            <select id="io_compression">
                                <option value="snappy">Snappy</option>
                                <option value="gzip">GZIP</option>
                                <option value="zstd">ZSTD</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Local Temp Directory:</label>
                        <input type="text" id="io_temp_dir" value="/tmp">
                    </div>
                </div>
            </div>
            
            <div class="preview-panel">
                <h3 style="color: #2c3e50; margin-bottom: 20px;">üìÑ YAML Preview</h3>
                <div class="yaml-output" id="yaml-output"></div>
            </div>
        </div>
        
        <div class="actions">
            <button class="download-btn" onclick="downloadYaml()">‚¨áÔ∏è Download config.yaml</button>
        </div>
    </div>

    <script>
        let sourceCounter = 0;
        let sources = [
            {
                name: 'parenttable',
                schema: 'bigclient',
                table: 'parenttable',
                timestamp_column: 'createdon',
                timestamp_utc: true,
                timestamp_naive: true,
                timestamp_columns: '[createdon]',
                last_n_days: 3,
                upper_bound_inclusive: false,
                output_filename: '{{schema}}_{{table}}_{{part_date}}.parquet',
                object_name: 'exports/{{schema}}/{{table}}/dt={{part_date}}/extract_{{run_ts}}.parquet',
                where_extra: '',
                query: ''
            },
            {
                name: 'childtable',
                schema: 'bigclient',
                table: 'childtable',
                timestamp_column: 'modifiedon',
                timestamp_utc: true,
                timestamp_naive: true,
                last_n_days: 1,
                upper_bound_inclusive: true,
                output_filename: '',
                object_name: '',
                where_extra: '',
                query: ''
            },
            {
                name: 'simplequery',
                schema: '',
                table: '',
                timestamp_column: 'modifiedon',
                timestamp_utc: true,
                timestamp_naive: true,
                last_n_days: 1,
                upper_bound_inclusive: false,
                output_filename: 'simplequery_{{part_date}}.parquet',
                object_name: 'exports/simplequery/dt={{part_date}}/users_{{run_ts}}.parquet',
                where_extra: '',
                query: 'SELECT *\nFROM bigclient.childtable\nWHERE 1 = 1\n-- this will be converted to subquery and additional WHERE clause injected with timestamp condition'
            }
        ];

        function toggleTargetConfig() {
            const targetType = document.getElementById('target_type').value;
            const configs = document.querySelectorAll('.target-config');
            configs.forEach(config => config.classList.remove('active'));
            document.getElementById(targetType + '-config').classList.add('active');
            updateYaml();
        }

        function addSource() {
            const newSource = {
                name: `source_${sourceCounter++}`,
                schema: '',
                table: '',
                timestamp_column: '',
                timestamp_utc: true,
                timestamp_naive: true,
                last_n_days: 1,
                upper_bound_inclusive: false,
                output_filename: '',
                object_name: '',
                where_extra: '',
                query: ''
            };
            sources.push(newSource);
            renderSources();
            updateYaml();
        }

        function removeSource(index) {
            sources.splice(index, 1);
            renderSources();
            updateYaml();
        }

        function renderSources() {
            const container = document.getElementById('sources-container');
            container.innerHTML = '';

            sources.forEach((source, index) => {
                const sourceDiv = document.createElement('div');
                sourceDiv.className = 'source-item';
                sourceDiv.innerHTML = `
                    <button class="remove-source" onclick="removeSource(${index})">√ó</button>
                    <h4>Source ${index + 1}: ${source.name}</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" value="${source.name}" onchange="updateSource(${index}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Timestamp Column:</label>
                            <input type="text" value="${source.timestamp_column}" onchange="updateSource(${index}, 'timestamp_column', this.value)">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Schema:</label>
                            <input type="text" value="${source.schema}" onchange="updateSource(${index}, 'schema', this.value)" ${source.query ? 'disabled' : ''}>
                        </div>
                        <div class="form-group">
                            <label>Table:</label>
                            <input type="text" value="${source.table}" onchange="updateSource(${index}, 'table', this.value)" ${source.query ? 'disabled' : ''}>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Custom Query (optional - leave empty for table extract):</label>
                        <textarea onchange="updateSource(${index}, 'query', this.value)" placeholder="Leave empty for table extract">${source.query}</textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Last N Days:</label>
                            <input type="number" value="${source.last_n_days}" onchange="updateSource(${index}, 'last_n_days', parseInt(this.value))">
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" ${source.upper_bound_inclusive ? 'checked' : ''} onchange="updateSource(${index}, 'upper_bound_inclusive', this.checked)">
                                <label>Upper Bound Inclusive</label>
                            </div>
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" ${source.timestamp_utc ? 'checked' : ''} onchange="updateSource(${index}, 'timestamp_utc', this.checked)">
                        <label>Timestamp UTC</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" ${source.timestamp_naive ? 'checked' : ''} onchange="updateSource(${index}, 'timestamp_naive', this.checked)">
                        <label>Timestamp Naive</label>
                    </div>
                    <div class="form-group">
                        <label>Timestamp Column(s) List (optional-ensure Parquet writes real datetimes):</label>
                        <input type="text" value="${source.timestamp_columns}" onchange="updateSource(${index}, 'timestamp_columns', this.value)" placeholder="[createdon, modifiedon]">
                    </div>
                    <div class="form-group">
                        <label>Output Filename Template (optional):</label>
                        <input type="text" value="${source.output_filename}" onchange="updateSource(${index}, 'output_filename', this.value)" placeholder="{{schema}}_{{table}}_{{part_date}}.parquet">
                    </div>

                    <div class="form-group">
                        <label>Object Name Template (optional):</label>
                        <input type="text" value="${source.object_name}" onchange="updateSource(${index}, 'object_name', this.value)" placeholder="exports/{{schema}}/{{table}}/dt={{part_date}}/extract_{{run_ts}}.parquet">
                    </div>

                    <div class="form-group">
                        <label>Extra WHERE Clause (optional):</label>
                        <input type="text" value="${source.where_extra}" onchange="updateSource(${index}, 'where_extra', this.value)" placeholder="status <> 'TEST'">
                    </div>
                `;
                container.appendChild(sourceDiv);
            });
        }

        function updateSource(index, field, value) {
            sources[index][field] = value;
            
            // If query is filled, disable schema and table
            if (field === 'query') {
                renderSources();
            }
            
            updateYaml();
        }

        function updateYaml() {
            const config = {
                source_database: {
                    type: document.getElementById('db_type').value,
                    host: document.getElementById('db_host').value,
                    port: parseInt(document.getElementById('db_port').value),
                    database: document.getElementById('db_database').value,
                    user: document.getElementById('db_user').value,
                    password: document.getElementById('db_password').value,
                    url: document.getElementById('url').value
                },
                    
                sources: sources.map(source => {
                    const sourceConfig = {
                        name: source.name,
                        timestamp_column: source.timestamp_column,
                        timestamp_utc: source.timestamp_utc,
                        timestamp_naive: source.timestamp_naive,
                        last_n_days: source.last_n_days,
                        upper_bound_inclusive: source.upper_bound_inclusive
                    };
                    if (source.timestamp_columns) sourceConfig.timestamp_columns = source.timestamp_columns;
                    if (source.query) {
                        sourceConfig.query = source.query;
                    } else {
                        if (source.schema) sourceConfig.schema = source.schema;
                        if (source.table) sourceConfig.table = source.table;
                    }

                    if (source.output_filename) sourceConfig.output_filename = source.output_filename;
                    if (source.object_name) sourceConfig.object_name = source.object_name;
                    if (source.where_extra) sourceConfig.where_extra = source.where_extra;

                    return sourceConfig;
                }),
                target: {
                    type: document.getElementById('target_type').value,
                    object_name: document.getElementById('global_object_name').value
                },
                io: {
                    chunksize: parseInt(document.getElementById('io_chunksize').value),
                    parquet_compression: document.getElementById('io_compression').value,
                    local_temp_dir: document.getElementById('io_temp_dir').value
                }
            };

            // Add target-specific configuration
            const targetType = document.getElementById('target_type').value;
            switch(targetType) {
                case 'gcs':
                    config.target.gcs = {
                        bucket: document.getElementById('gcs_bucket').value,
                        service_account_key_file: document.getElementById('gcs_key_file').value
                    };
                    break;
                case 's3':
                    config.target.s3 = {
                        bucket: document.getElementById('s3_bucket').value,
                        region: document.getElementById('s3_region').value,
                        aws_access_key_id: document.getElementById('s3_access_key').value,
                        aws_secret_access_key: document.getElementById('s3_secret_key').value
                    };
                    break;
                case 'azure':
                    config.target.azure = {
                        container: document.getElementById('azure_container').value,
                        account_name: document.getElementById('azure_account_name').value,
                        account_key: document.getElementById('azure_account_key').value
                    };
                    break;
            }

            const yamlString = jsyaml.dump(config, {
                indent: 2,
                lineWidth: 120,
                quotingType: '"',
                forceQuotes: false
            });

            document.getElementById('yaml-output').textContent = yamlString;
        }

        function downloadYaml() {
            const yamlContent = document.getElementById('yaml-output').textContent;
            const blob = new Blob([yamlContent], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'config.yaml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Add event listeners to all form elements
        document.addEventListener('DOMContentLoaded', function() {
            renderSources();
            updateYaml();

            // Add event listeners for all basic form fields
            const formFields = [
                'db_type', 'db_host', 'db_port', 'db_database', 'db_user', 'db_password','url',
                'target_type', 'global_object_name', 'gcs_bucket', 'gcs_key_file',
                's3_bucket', 's3_region', 's3_access_key', 's3_secret_key',
                'azure_container', 'azure_account_name', 'azure_account_key',
                'io_chunksize', 'io_compression', 'io_temp_dir'
            ];

            formFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('change', updateYaml);
                    element.addEventListener('input', updateYaml);
                }
            });
        });
    </script>
</body>
</html>